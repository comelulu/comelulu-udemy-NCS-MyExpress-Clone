# ✅ MyExpress 엔진 아키텍처 점검 – 실무에 투입 가능한 구조인가?

이번 시간에는 우리가 지금까지 직접 구현해온 MyExpress 엔진이 실무 환경에서도 안정적으로 동작할 수 있는 구조를 가지고 있는지를 점검해보고, 실제 서비스에 투입되기 전에 반드시 개선해야 할 아키텍처 상의 문제점들을 구체적으로 분석해보겠습니다.

단순히 요청을 받고 응답을 보내는 것만으로는 '웹 서버'라고 부를 수는 없습니다. 시간이 지남에 따라 새로운 기능이 추가되고, 다양한 미들웨어가 등록되며, 환경 설정도 계속 바뀌게 됩니다. 이런 상황에서도 **코드가 무너지지 않고 일관성 있게 작동하려면, 엔진 자체가 매우 견고하고 예외 상황에 강한 구조**를 가져야 합니다.

## ⚠️ 문제 1: 내부 설정 객체가 외부로 완전히 노출되어 있음

현재 MyExpress에서는 내부 설정을 다음과 같이 외부에서 자유롭게 정의하고 수정할 수 있도록 열려 있습니다.

```js
const app = createApplication();
app.settings = {}; // 👈 외부에서 직접 설정 객체를 주입
```

이 구조의 치명적인 문제는, 중요한 설정 정보가 외부에 그대로 노출되어 **아무나 변경하거나 삭제할 수 있다는 점**입니다.

```js
// 설정 값 덮어쓰기
app.settings.views = "/new/views/path";

// 설정 객체 자체 삭제
delete app.settings;
```

### 🧨 어떤 문제가 발생할 수 있을까?

- `views` 경로가 임의로 변경되면, 서버는 원래 의도한 템플릿 파일이 아닌 **잘못된 경로에서 파일을 읽게 됨**.
- 누군가 실수 혹은 의도로 `delete app.settings`를 호출하면, **서버가 모든 설정 정보를 상실**.
- 이는 템플릿 렌더링, MIME 타입 처리, 정적 파일 처리 등 모든 기능에 영향을 미치고, **즉시 장애 상태**로 이어짐.
- 특히 실무에서는 템플릿 경로가 외부에 노출될 경우, 악의적인 사용자가 민감한 파일을 직접 요청하게 되는 **심각한 보안 사고**로도 이어질 수 있음.

이처럼 외부에서 설정 객체를 직접 수정할 수 있다는 것은 **보안성과 안정성 모두에 치명적인 취약점을 만드는 일**입니다.

---

## ⚠️ 문제 2: 서버 인스턴스를 마음대로 여러 개 만들 수 있음

현 구조에서는 다음과 같이 여러 개의 app 인스턴스를 생성하는 것이 전혀 제한되지 않습니다.

```js
const app1 = createApplication();
const app2 = createApplication(); // 👈 서로 독립된 상태를 가짐
```

겉보기에는 아무 문제 없어 보일 수 있지만, 실제로는 심각한 혼란을 초래합니다.

### ❗ 실무에서 자주 발생하는 문제 시나리오

```js
// app1에 인증 미들웨어 등록
app1.use(authMiddleware);

// 그러나 개발자가 실수로 app2로 서버 실행
app2.listen(3000);
```

이럴 경우:

- 개발자는 분명히 인증 미들웨어를 등록했다고 생각함.
- 하지만 실제 요청을 처리하는 것은 app2 → 인증 미들웨어가 적용되지 않음.
- 그 결과 **누구나 인증 없이 민감한 API에 접근 가능**.

이 문제는 심지어 개발자가 직접 눈으로 코드를 확인하더라도 **한눈에 드러나지 않는다는 점**이 더 위험합니다. 아래와 같은 코드 구조에서 `app1`, `app2`가 혼용되면 오류가 사소해 보이기 때문에 쉽게 간과됩니다.

---

## 🧠 시각화: 인스턴스가 분리된 상태의 문제 구조

```txt
[app1]                            [app2]
settings: { views: "/secure" }    settings: {}
middlewares: [authMiddleware]     middlewares: []

❌ 실제 listen은 app2 → 인증 미들웨어 없음
❌ 템플릿 설정 없음 → 렌더링 실패
```

### 🧨 실무에서 발생 가능한 실제 장애 사례

1. 인증 미들웨어가 빠져 모든 사용자가 관리자 API 접근
2. 환경 설정이 누락되어 데이터베이스 연결 실패
3. 로깅 미들웨어가 빠져, 문제 발생 시 추적 불가능
4. 데이터 검증 미들웨어 누락 → 잘못된 값이 DB에 저장됨

이러한 문제들은 **개발 초기 단계에서는 눈에 띄지 않지만**, 배포 후 실무에서 바로 **서비스 중단이나 보안 사고**로 이어질 수 있습니다.

---

## 🧩 핵심 원인: 인스턴스 중복과 상태 분리

결국 위 문제들은 모두 하나의 공통된 원인으로 귀결됩니다:

> **"서버 인스턴스가 여러 개 생성되고, 그중 어떤 인스턴스를 사용할지 명확하지 않다."**

- 설정이 어디에 있는지 불분명
- 미들웨어가 어떤 인스턴스에 등록되었는지 추적 불가
- 라우터 등록 여부를 코드로만 파악하기 어려움

---

## 🔐 해결책 1: Singleton 패턴

> 전역적으로 오직 하나의 인스턴스만 존재하도록 보장하는 패턴

### ✅ 적용 시 효과

- **중앙 집중형 제어**: 모든 설정, 미들웨어 등록, 라우팅이 한 곳에 집중됨
- **코드 일관성 유지**: 어떤 상황에서도 같은 인스턴스를 참조
- **불필요한 중복 제거**: 실수로 여러 인스턴스를 만드는 문제 방지
- **유지보수성 향상**: 어디에서나 같은 객체를 사용하므로 추적이 쉬움

---

## 🧪 해결책 2: IIFE (Immediately Invoked Function Expression)

> 중요한 내부 상태를 감싸 외부 접근을 차단하는 함수 구조

```js
const app = (function () {
  const settings = {};
  const middlewares = [];

  function use(mw) {
    middlewares.push(mw);
  }

  function getSettings() {
    return { ...settings };
  }

  return { use, getSettings };
})();
```

### ✅ 적용 시 효과

- 내부 상태(`settings`, `middlewares`)에 외부에서 직접 접근 불가
- `delete app.settings`와 같은 조작 원천 차단
- 필요한 인터페이스만 외부에 노출 → 안전한 API 설계 가능
- **캡슐화(Encapsulation)** 를 통해 정보 은닉

---

## 🎯 정리 – 지금의 MyExpress는 실무에 바로 쓰기엔 위험하다

| 항목               | 현재 구조                      | 개선 방향 (Singleton + IIFE)         |
| ------------------ | ------------------------------ | ------------------------------------ |
| 설정 객체 보호     | 외부에서 직접 수정 가능        | 내부에 숨기고, get/set 메서드로 제한 |
| 인스턴스 생성 제한 | 여러 개 생성 가능              | 오직 하나만 존재하도록 제한          |
| 코드 일관성        | 미들웨어/라우터 등록 누락 가능 | 중앙 집중형 구조로 통합 관리         |
| 유지보수/확장성    | 디버깅 어렵고, 실수 잦음       | 명확한 구조로 상태 추적 가능         |

---

## 📌 오늘의 핵심 정리

- 현재 MyExpress 구조는 **설정 노출, 인스턴스 중복, 상태 불일치**라는 구조적 문제를 가지고 있습니다.
- 이는 실무 환경에서 **심각한 장애나 보안 사고**로 이어질 수 있습니다.
- 이를 해결하기 위해 우리는 **Singleton 패턴과 IIFE 패턴을 도입**해야 합니다.
- 이 두 가지 설계 기법을 통해, **안정적이고 신뢰할 수 있는 서버 아키텍처**로 한 단계 발전시킬 수 있습니다.

---
